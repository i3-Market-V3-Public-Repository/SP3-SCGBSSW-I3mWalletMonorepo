import{Session as t}from"@i3m/wallet-protocol";import{BehaviorSubject as s}from"rxjs";import*as i from"node:readline/promises";import{randomBytes as e,createCipheriv as o,createDecipheriv as a,scrypt as r,createSecretKey as n}from"crypto";import{tmpdir as h}from"os";import{mkdir as l,readFile as c,writeFile as p,rm as d}from"fs/promises";import{join as w,dirname as f}from"path";const u=async t=>{{const s=await Promise.resolve().then((function(){return v}));return await s.pinConsoleDialog(t?.consoleDialog)}},y=u;class g{constructor(t){this.fetch=async(...t)=>{if(await this.initialized,null==this.session)throw new Error("no session");return await this.session.send(...t)},this.protocol=t.protocol,this.$session=new s(void 0),this.initialized=this.init()}async init(t,s){if(void 0===t){const t=(await Promise.resolve().then((function(){return S}))).SessionFileStorage;this.storage=new t(s?.fileStorage)}else this.storage=t}get hasSession(){return void 0!==this.session}async createIfNotExists(){if(await this.initialized,void 0!==this.session)return this.session;const t=await this.protocol.run();return await this.setSession(t),t}async removeSession(){await this.initialized,await this.setSession()}async setSession(t){if(await this.initialized,this.session=t,null==t)await this.storage.clear();else{const s=t.toJSON();await this.storage.setSessionData(s)}this.$session.next(t)}async loadSession(){let s;await this.initialized;try{const i=await this.storage.getSessionData();null!==i&&(s=await t.fromJSON(this.protocol.transport,i))}catch(t){}await this.setSession(s)}}class m extends g{constructor(t,s={}){super({protocol:t,storageOptions:{localStorage:{key:s.localStorageKey}}}),this.protocol=t}}var v=Object.freeze({__proto__:null,pinConsoleDialog:async t=>{const s=t?.message??"Introduce the PIN: ",e=i.createInterface({input:process.stdin,output:process.stdout}),o=await e.question(s);return console.log(o),e.close(),o}});var S=Object.freeze({__proto__:null,SessionFileStorage:class{constructor(t){this.filepath="string"==typeof t?.filepath&&""!==t.filepath?t.filepath:w(h(),"i3m-wallet-session"),this.password=t?.password,this.initialized=this.init()}async deriveKey(t,s){this.salt=s??e(64),this.key=await async function(t,s,i=!1){let e={};void 0!==s.algOptions&&(e={N:16384,r:8,p:1,...s.algOptions},e.maxmem=256*e.N*e.r);const o=new Promise(((o,a)=>{r(t,s.salt,s.derivedKeyLength,e,((t,s)=>{null!==t&&a(t),o(i?s:n(s))}))}));return await o}(t,{alg:"scrypt",derivedKeyLength:32,salt:this.salt})}async init(){await l(f(this.filepath),{recursive:!0}),void 0!==this.password&&await this.deriveKey(this.password)}async encryptJson(t){if(void 0===this.key||void 0===this.password||void 0===this.salt)throw new Error("For the session to be encrypted you must provide a password");const s=JSON.stringify(t),i=e(16),a=o("aes-256-gcm",this.key,i),r=Buffer.concat([a.update(s,"utf8"),a.final()]),n=a.getAuthTag();return Buffer.concat([this.salt,i,n,r])}async decryptToJson(t){if(void 0===this.key||void 0===this.password||void 0===this.salt)throw new Error("For the session to be encrypted you must provide a password");const s=Buffer.from(t),i=s.subarray(0,64);0!==i.compare(this.salt)&&await this.deriveKey(this.password,i);const e=s.subarray(64,80),o=s.subarray(80,96),r=s.subarray(96),n=a("aes-256-gcm",this.key,e);n.setAuthTag(o);return JSON.parse(Buffer.concat([n.update(r),n.final()]).toString("utf8"))}async getSessionData(){let t;await this.initialized;const s=await c(this.filepath);if(t=void 0===this.password?s.toString("utf8"):await this.decryptToJson(s),""===t)throw new Error("invalid storage file or invalid format");return t}async setSessionData(t){await this.initialized,void 0===this.password?await p(this.filepath,JSON.stringify(t),{encoding:"utf8"}):await p(this.filepath,await this.encryptJson(t))}async clear(){await this.initialized,await d(this.filepath,{force:!0})}}});export{m as LocalSessionManager,g as SessionManager,y as openModal,u as pinDialog};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXgubm9kZS5qcyIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3RzL3Bpbi1kaWFsb2cudHMiLCIuLi8uLi9zcmMvdHMvc2Vzc2lvbi1tYW5hZ2VyLnRzIiwiLi4vLi4vc3JjL3RzL3Bpbi1kaWFsb2dzL3Bpbi1jb25zb2xlLWRpYWxvZy50cyIsIi4uLy4uL3NyYy90cy9zZXNzaW9uLXN0b3JhZ2VzL3Nlc3Npb24tZmlsZS1zdG9yYWdlLnRzIl0sInNvdXJjZXNDb250ZW50IjpudWxsLCJuYW1lcyI6WyJwaW5EaWFsb2ciLCJhc3luYyIsIm9wdHMiLCJwaW5Db25zb2xlRGlhbG9nIiwiUHJvbWlzZSIsImNvbnNvbGVEaWFsb2ciLCJvcGVuTW9kYWwiLCJTZXNzaW9uTWFuYWdlciIsImNvbnN0cnVjdG9yIiwib3B0aW9ucyIsInRoaXMiLCJmZXRjaCIsImFyZ3MiLCJpbml0aWFsaXplZCIsInNlc3Npb24iLCJFcnJvciIsInNlbmQiLCJwcm90b2NvbCIsIiRzZXNzaW9uIiwiQmVoYXZpb3JTdWJqZWN0IiwidW5kZWZpbmVkIiwiaW5pdCIsInN0b3JhZ2UiLCJzdG9yYWdlT3B0aW9ucyIsIlNlc3Npb25GaWxlU3RvcmFnZSIsInJlc29sdmUiLCJ0aGVuIiwic2Vzc2lvbkZpbGVTdG9yYWdlIiwiZmlsZVN0b3JhZ2UiLCJoYXNTZXNzaW9uIiwicnVuIiwic2V0U2Vzc2lvbiIsImNsZWFyIiwic2Vzc2lvbkpzb24iLCJ0b0pTT04iLCJzZXRTZXNzaW9uRGF0YSIsIm5leHQiLCJnZXRTZXNzaW9uRGF0YSIsIlNlc3Npb24iLCJmcm9tSlNPTiIsInRyYW5zcG9ydCIsImVycm9yIiwiTG9jYWxTZXNzaW9uTWFuYWdlciIsInN1cGVyIiwibG9jYWxTdG9yYWdlIiwia2V5IiwibG9jYWxTdG9yYWdlS2V5IiwicXVlcnkiLCJtZXNzYWdlIiwicmwiLCJyZWFkbGluZSIsImNyZWF0ZUludGVyZmFjZSIsImlucHV0IiwicHJvY2VzcyIsInN0ZGluIiwib3V0cHV0Iiwic3Rkb3V0IiwicGluIiwicXVlc3Rpb24iLCJjb25zb2xlIiwibG9nIiwiY2xvc2UiLCJmaWxlcGF0aCIsImpvaW4iLCJ0bXBkaXIiLCJwYXNzd29yZCIsInNhbHQiLCJyYW5kb21CeXRlcyIsInJldHVybkJ1ZmZlciIsInNjcnlwdE9wdGlvbnMiLCJhbGdPcHRpb25zIiwiTiIsInIiLCJwIiwibWF4bWVtIiwia2V5UHJvbWlzZSIsInJlamVjdCIsInNjcnlwdCIsImRlcml2ZWRLZXlMZW5ndGgiLCJlcnIiLCJjcmVhdGVTZWNyZXRLZXkiLCJkZXJpdmVLZXkiLCJhbGciLCJta2RpciIsImRpcm5hbWUiLCJyZWN1cnNpdmUiLCJqc29uIiwicGxhaW50ZXh0IiwiSlNPTiIsInN0cmluZ2lmeSIsIml2IiwiY2lwaGVyIiwiY3JlYXRlQ2lwaGVyaXYiLCJlbmNyeXB0ZWQiLCJCdWZmZXIiLCJjb25jYXQiLCJ1cGRhdGUiLCJmaW5hbCIsInRhZyIsImdldEF1dGhUYWciLCJjcnlwdG9ncmFtIiwiYnVmIiwiZnJvbSIsInN1YmFycmF5IiwiY29tcGFyZSIsImNpcGhlcnRleHQiLCJkZWNpcGhlciIsImNyZWF0ZURlY2lwaGVyaXYiLCJzZXRBdXRoVGFnIiwicGFyc2UiLCJ0b1N0cmluZyIsIml0ZW0iLCJmaWxlQnVmIiwicmVhZEZpbGUiLCJkZWNyeXB0VG9Kc29uIiwid3JpdGVGaWxlIiwiZW5jb2RpbmciLCJlbmNyeXB0SnNvbiIsInJtIiwiZm9yY2UiXSwibWFwcGluZ3MiOiJtWUFPYUEsRUFBWUMsTUFBT0MsSUFJdkIsQ0FDTCxNQUFNQyxRQUF5QkMsK0NBQy9CLGFBQWFELEVBQWlCQSxpQkFBaUJELEdBQU1HLGNBQ3RELEdBU1VDLEVBQVlOLFFDaEJaTyxFQU9YQyxZQUFhQyxHQXdCYkMsS0FBQUMsTUFBNEJWLFNBQVVXLEtBR3BDLFNBRk1GLEtBQUtHLFlBRVMsTUFBaEJILEtBQUtJLFFBQ1AsTUFBTSxJQUFJQyxNQUFNLGNBR2xCLGFBQWFMLEtBQUtJLFFBQVFFLFFBQVFKLEVBQUssRUE5QnZDRixLQUFLTyxTQUFXUixFQUFRUSxTQUN4QlAsS0FBS1EsU0FBVyxJQUFJQyxPQUF3Q0MsR0FDNURWLEtBQUtHLFlBQWNILEtBQUtXLE1BQ3pCLENBRU9wQixXQUFZcUIsRUFBMEJDLEdBQzVDLFFBQWdCSCxJQUFaRSxFQUlLLENBQ0wsTUFBTUUsU0FBNEJwQixRQUFpRHFCLFVBQUFDLE1BQUEsV0FBQSxPQUFBQyxDQUFBLEtBQUVILG1CQUNyRmQsS0FBS1ksUUFBVSxJQUFJRSxFQUFtQkQsR0FBZ0JLLFlBQ3ZELE1BRURsQixLQUFLWSxRQUFVQSxDQUVsQixDQUVHTyxpQkFDRixZQUF3QlQsSUFBakJWLEtBQUtJLE9BQ2IsQ0FZRGIsMEJBR0UsU0FGTVMsS0FBS0csaUJBRVVPLElBQWpCVixLQUFLSSxRQUNQLE9BQU9KLEtBQUtJLFFBRWQsTUFBTUEsUUFBZ0JKLEtBQUtPLFNBQVNhLE1BR3BDLGFBRk1wQixLQUFLcUIsV0FBV2pCLEdBRWZBLENBQ1IsQ0FFRGIsNEJBQ1FTLEtBQUtHLGtCQUVMSCxLQUFLcUIsWUFDWixDQUVEOUIsaUJBQWtCYSxHQUloQixTQUhNSixLQUFLRyxZQUVYSCxLQUFLSSxRQUFVQSxFQUNYQSxjQUNJSixLQUFLWSxRQUFRVSxZQUNkLENBQ0wsTUFBTUMsRUFBY25CLEVBQVFvQixlQUN0QnhCLEtBQUtZLFFBQVFhLGVBQWVGLEVBQ25DLENBQ0R2QixLQUFLUSxTQUFTa0IsS0FBS3RCLEVBQ3BCLENBRURiLG9CQUdFLElBQUlhLFFBRkVKLEtBQUtHLFlBR1gsSUFDRSxNQUFNb0IsUUFBb0J2QixLQUFLWSxRQUFRZSxpQkFDbkIsT0FBaEJKLElBQ0ZuQixRQUFnQndCLEVBQVFDLFNBQVM3QixLQUFLTyxTQUFTdUIsVUFBV1AsR0FFNUMsQ0FBaEIsTUFBT1EsR0FBUyxPQUVaL0IsS0FBS3FCLFdBQVdqQixFQUN2QixFQVFHLE1BQU80QixVQUE2RG5DLEVBQ3hFQyxZQUF1QlMsRUFBNkJSLEVBQTBDLElBQzVGa0MsTUFBTSxDQUFFMUIsV0FBVU0sZUFBZ0IsQ0FBRXFCLGFBQWMsQ0FBRUMsSUFBS3BDLEVBQVFxQyxvQkFENUNwQyxLQUFRTyxTQUFSQSxDQUV0Qix1REMvRjZCaEIsTUFBT1EsSUFDckMsTUFBTXNDLEVBQVF0QyxHQUFTdUMsU0FBVyxzQkFFNUJDLEVBQUtDLEVBQVNDLGdCQUFnQixDQUNsQ0MsTUFBT0MsUUFBUUMsTUFDZkMsT0FBUUYsUUFBUUcsU0FHWkMsUUFBWVIsRUFBR1MsU0FBU1gsR0FJOUIsT0FIQVksUUFBUUMsSUFBSUgsR0FDWlIsRUFBR1ksUUFFSUosQ0FBRyxpRUNOVmpELFlBQWFDLEdBQ1hDLEtBQUtvRCxTQUF5QyxpQkFBdEJyRCxHQUFTcUQsVUFBOEMsS0FBckJyRCxFQUFRcUQsU0FBbUJyRCxFQUFRcUQsU0FBV0MsRUFBS0MsSUFBVSxzQkFDdkh0RCxLQUFLdUQsU0FBV3hELEdBQVN3RCxTQUN6QnZELEtBQUtHLFlBQWNILEtBQUtXLE1BQ3pCLENBRU9wQixnQkFBaUJnRSxFQUFrQkMsR0FDekN4RCxLQUFLd0QsS0FBT0EsR0FBUUMsRUFBWSxJQUVoQ3pELEtBQUttQyxVQTRHVDVDLGVBQXdEZ0UsRUFBc0IvRCxFQUFrQmtFLEdBQWUsR0FDN0csSUFBSUMsRUFBK0IsQ0FBQSxPQUNYakQsSUFBcEJsQixFQUFLb0UsYUFDUEQsRUFBZ0IsQ0FDZEUsRUFBRyxNQUNIQyxFQUFHLEVBQ0hDLEVBQUcsS0FDQXZFLEVBQUtvRSxZQUVWRCxFQUFjSyxPQUFTLElBQU1MLEVBQWNFLEVBQUtGLEVBQWNHLEdBRWhFLE1BQU1HLEVBQTJCLElBQUl2RSxTQUFRLENBQUNxQixFQUFTbUQsS0FDckRDLEVBQU9aLEVBQVUvRCxFQUFLZ0UsS0FBTWhFLEVBQUs0RSxpQkFBa0JULEdBQWUsQ0FBQ1UsRUFBS2xDLEtBQzFELE9BQVJrQyxHQUFjSCxFQUFPRyxHQUN6QnRELEVBQVEyQyxFQUFldkIsRUFBTW1DLEVBQWdCbkMsR0FBSyxHQUNsRCxJQUVKLGFBQWE4QixDQUNmLENBOUhxQk0sQ0FBVWhCLEVBQVUsQ0FDbkNpQixJQUFLLFNBQ0xKLGlCQUFrQixHQUNsQlosS0FBTXhELEtBQUt3RCxNQUVkLENBRU9qRSxtQkFDQWtGLEVBQU1DLEVBQVExRSxLQUFLb0QsVUFBVyxDQUFFdUIsV0FBVyxTQUMzQmpFLElBQWxCVixLQUFLdUQsZ0JBQ0R2RCxLQUFLdUUsVUFBVXZFLEtBQUt1RCxTQUU3QixDQUVPaEUsa0JBQW1CcUYsR0FDekIsUUFBaUJsRSxJQUFiVixLQUFLbUMsVUFBdUN6QixJQUFsQlYsS0FBS3VELGVBQXdDN0MsSUFBZFYsS0FBS3dELEtBQ2hFLE1BQU0sSUFBSW5ELE1BQU0sK0RBR2xCLE1BQU13RSxFQUFZQyxLQUFLQyxVQUFVSCxHQUczQkksRUFBS3ZCLEVBQVksSUFHakJ3QixFQUFTQyxFQUFlLGNBQWVsRixLQUFLbUMsSUFBSzZDLEdBR2pERyxFQUFZQyxPQUFPQyxPQUFPLENBQUNKLEVBQU9LLE9BQU9ULEVBQVcsUUFBU0ksRUFBT00sVUFHcEVDLEVBQU1QLEVBQU9RLGFBR25CLE9BQU9MLE9BQU9DLE9BQU8sQ0FBQ3JGLEtBQUt3RCxLQUFNd0IsRUFBSVEsRUFBS0wsR0FDM0MsQ0FFTzVGLG9CQUFxQm1HLEdBQzNCLFFBQWlCaEYsSUFBYlYsS0FBS21DLFVBQXVDekIsSUFBbEJWLEtBQUt1RCxlQUF3QzdDLElBQWRWLEtBQUt3RCxLQUNoRSxNQUFNLElBQUluRCxNQUFNLCtEQUlsQixNQUFNc0YsRUFBTVAsT0FBT1EsS0FBS0YsR0FDbEJsQyxFQUFPbUMsRUFBSUUsU0FBUyxFQUFHLElBQ0csSUFBNUJyQyxFQUFLc0MsUUFBUTlGLEtBQUt3RCxhQUNkeEQsS0FBS3VFLFVBQVV2RSxLQUFLdUQsU0FBVUMsR0FFdEMsTUFBTXdCLEVBQUtXLEVBQUlFLFNBQVMsR0FBSSxJQUN0QkwsRUFBTUcsRUFBSUUsU0FBUyxHQUFJLElBQ3ZCRSxFQUFhSixFQUFJRSxTQUFTLElBRzFCRyxFQUFXQyxFQUFpQixjQUFlakcsS0FBS21DLElBQUs2QyxHQUMzRGdCLEVBQVNFLFdBQVdWLEdBS3BCLE9BRmtCVixLQUFLcUIsTUFBTWYsT0FBT0MsT0FBTyxDQUFDVyxFQUFTVixPQUFPUyxHQUFhQyxFQUFTVCxVQUFVYSxTQUFTLFFBR3RHLENBRUQ3Ryx1QkFHRSxJQUFJOEcsUUFGRXJHLEtBQUtHLFlBR1gsTUFBTW1HLFFBQWdCQyxFQUFTdkcsS0FBS29ELFVBTXBDLEdBSkVpRCxPQURvQjNGLElBQWxCVixLQUFLdUQsU0FDQStDLEVBQVFGLFNBQVMsY0FFWHBHLEtBQUt3RyxjQUFjRixHQUVyQixLQUFURCxFQUFhLE1BQU0sSUFBSWhHLE1BQU0sMENBQ2pDLE9BQU9nRyxDQUNSLENBRUQ5RyxxQkFBc0JxRixTQUNkNUUsS0FBS0csaUJBRVdPLElBQWxCVixLQUFLdUQsZUFDRGtELEVBQVV6RyxLQUFLb0QsU0FBVTBCLEtBQUtDLFVBQVVILEdBQU8sQ0FBRThCLFNBQVUsZUFFM0RELEVBQVV6RyxLQUFLb0QsZUFBZ0JwRCxLQUFLMkcsWUFBWS9CLEdBRXpELENBRURyRixvQkFDUVMsS0FBS0csa0JBQ0x5RyxFQUFHNUcsS0FBS29ELFNBQVUsQ0FBRXlELE9BQU8sR0FDbEMifQ==
