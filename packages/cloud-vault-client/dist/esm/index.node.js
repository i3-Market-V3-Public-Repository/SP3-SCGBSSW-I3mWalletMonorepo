import t,{AxiosError as e}from"axios";import i from"eventsource";import{randomBytes as r}from"node:crypto";import{EventEmitter as s}from"node:events";import{config as a}from"dotenv";a();const o=(t,e)=>{let i=`Invalid value for ${t}. `;return void 0!==e&&(i+=`Allowed values are ${e} `),i},n=["0","false","FALSE"],l=["1","true","FALSE"],u=n.concat(l);function h(t,e){const i=void 0===(r=process.env[t])?"":r;var r;const s=(e=e??{})?.isBoolean??!1;if(s&&(e={...e,allowedValues:u}),""===i){if(void 0!==e.defaultValue)return e.defaultValue;if(void 0!==e.allowedValues&&!e.allowedValues.includes(""))throw new RangeError(o(t,e.allowedValues.join(", ")))}if(s&&l.includes(i))return!0;if(s&&n.includes(i))return!1;if(void 0!==e.allowedValues&&!e.allowedValues.includes(i))throw new RangeError(o(t,e.allowedValues.join(", ")));return i}h("NODE_ENV",{defaultValue:"production",allowedValues:["production","development"]});const d="v"+h("npm_package_version",{defaultValue:"0.0.1"})[0];class m extends s{timestamp;token;name;serverUrl;vaultPath;publicKeyPath;es;constructor(t,e){super(),this.name=e??r(16).toString("hex"),this.serverUrl=t,this.vaultPath=`/api/${d}/vault`,this.publicKeyPath=`/api/${d}/registration/public-jwk`}async initEventSourceClient(){if(void 0===this.token)throw new Error("Cannot subscribe to events without login first");const t=this.serverUrl+this.vaultPath+"/events";this.es=new i(t,{headers:{Authorization:"Bearer "+this.token}}),this.es.onmessage=t=>{console.log(t)},this.es.addEventListener("connected",(t=>{const e=JSON.parse(t.data);this.emit("connected",e.timestamp)})),this.es.addEventListener("storage-updated",(t=>{const e=JSON.parse(t.data);e.timestamp!==this.timestamp&&(this.timestamp=e.timestamp,this.emit("storage-updated",this.timestamp))})),this.es.addEventListener("storage-deleted",(t=>{this.emit("storage-updated")})),this.es.onerror=t=>{this.emit("error",t)}}close(){this.logout(),this.emit("close")}async login(i,r){const s={username:i,authkey:r};try{const e=await t.post(this.serverUrl+this.vaultPath+"/auth",s);if(200!==e.status)return!1;const i=e.data;return this.token=i.token,await this.initEventSourceClient(),this.emit("logged-in"),!0}catch(t){return t instanceof e?this.emit("error",t.response?.data):this.emit("error",t),!1}}logout(){this.token=void 0,this.es?.close()}async getRemoteStorageTimestamp(){try{if(void 0===this.token)return this.emit("login-required"),null;const e=await t.get(this.serverUrl+this.vaultPath+"/timestamp",{headers:{Authorization:"Bearer "+this.token,"Content-Type":"application/json"}});if(200!==e.status){const t=e.data;return"Unauthorized"===t.name?(this.logout(),this.emit("login-required")):this.emit("error",new Error(t.name,{cause:t.description})),null}return e.data.timestamp}catch(t){return t instanceof e?this.emit("error",t.response?.data):this.emit("error",t),null}}async updateStorage(i,r=!1){try{if(void 0===this.token)return this.emit("login-required"),!1;if(r){const t=await this.getRemoteStorageTimestamp();i.timestamp=null!==t?t:void 0}const e=await t.post(this.serverUrl+this.vaultPath,i,{headers:{Authorization:"Bearer "+this.token,"Content-Type":"application/json"}});if(201!==e.status){return"Unauthorized"===e.data.name?(this.logout(),this.emit("login-required")):this.emit("error",e.data),!1}return this.timestamp=e.data.timestamp,!0}catch(t){t instanceof e?this.emit("error",t.response?.data):this.emit("error",t)}return!1}async deleteStorage(){try{if(void 0===this.token)return this.logout(),this.emit("login-required"),!1;const e=await t.delete(this.serverUrl+this.vaultPath,{headers:{Authorization:"Bearer "+this.token}});if(204!==e.status){return"Unauthorized"===e.data.name?(this.logout(),this.emit("login-required")):this.emit("error",e.data),!1}return this.emit("storage-deleted"),!0}catch(t){t instanceof e?this.emit("error",t.response?.data):this.emit("error",t)}return!1}async getServerPublicKey(){try{const e=await t.get(this.serverUrl+this.publicKeyPath);return 200!==e.status?(this.emit("error",e.statusText),null):e.data.jwk}catch(t){return t instanceof e?this.emit("error",t.response?.data):this.emit("error",t),null}}}export{m as VaultClient};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXgubm9kZS5qcyIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3RzL2NvbmZpZy9wYXJzZVByb2Nlc3NFbnZWYXIudHMiLCIuLi8uLi9zcmMvdHMvY29uZmlnL2luZGV4LnRzIiwiLi4vLi4vc3JjL3RzL3ZhdWx0LWNsaWVudC50cyJdLCJzb3VyY2VzQ29udGVudCI6bnVsbCwibmFtZXMiOlsibG9hZEVudkZpbGUiLCJpbnZhbGlkTXNnIiwidmFybmFtZSIsInZhbHVlcyIsInJldCIsInVuZGVmaW5lZCIsImJvb2xlYW5GYWxzZUFsbG93ZWRWYWx1ZXMiLCJib29sZWFuVHJ1ZUFsbG93ZWRWYWx1ZXMiLCJib29sZWFuQWxsb3dlZFZhbHVlcyIsImNvbmNhdCIsInBhcnNlUHJvY2Nlc3NFbnZWYXIiLCJ2YXJOYW1lIiwib3B0aW9ucyIsInZhbHVlIiwiYSIsInByb2Nlc3MiLCJlbnYiLCJpc0Jvb2xlYW4iLCJhbGxvd2VkVmFsdWVzIiwiZGVmYXVsdFZhbHVlIiwiaW5jbHVkZXMiLCJSYW5nZUVycm9yIiwiam9pbiIsImFwaVZlcnNpb24iLCJWYXVsdENsaWVudCIsIkV2ZW50RW1pdHRlciIsInRpbWVzdGFtcCIsInRva2VuIiwibmFtZSIsInNlcnZlclVybCIsInZhdWx0UGF0aCIsInB1YmxpY0tleVBhdGgiLCJlcyIsImNvbnN0cnVjdG9yIiwic3VwZXIiLCJ0aGlzIiwicmFuZG9tQnl0ZXMiLCJ0b1N0cmluZyIsImFzeW5jIiwiRXJyb3IiLCJzc2VFbmRwb2ludCIsIkV2ZW50U291cmNlIiwiaGVhZGVycyIsIkF1dGhvcml6YXRpb24iLCJvbm1lc3NhZ2UiLCJtc2ciLCJjb25zb2xlIiwibG9nIiwiYWRkRXZlbnRMaXN0ZW5lciIsImUiLCJKU09OIiwicGFyc2UiLCJkYXRhIiwiZW1pdCIsIm9uZXJyb3IiLCJjbG9zZSIsImxvZ291dCIsInVzZXJuYW1lIiwiYXV0aGtleSIsInJlcUJvZHkiLCJyZXMiLCJheGlvcyIsInBvc3QiLCJzdGF0dXMiLCJib2R5IiwiaW5pdEV2ZW50U291cmNlQ2xpZW50IiwiZXJyb3IiLCJBeGlvc0Vycm9yIiwicmVzcG9uc2UiLCJnZXQiLCJjYXVzZSIsImRlc2NyaXB0aW9uIiwic3RvcmFnZSIsImZvcmNlIiwiZ2V0UmVtb3RlU3RvcmFnZVRpbWVzdGFtcCIsImRlbGV0ZSIsInN0YXR1c1RleHQiLCJqd2siXSwibWFwcGluZ3MiOiJzTEFFQUEsSUFNQSxNQUFNQyxFQUFhLENBQUNDLEVBQWlCQyxLQUNuQyxJQUFJQyxFQUFNLHFCQUFxQkYsTUFFL0IsWUFEZUcsSUFBWEYsSUFBc0JDLEdBQU8sc0JBQXNCRCxNQUNoREMsQ0FBRyxFQUVORSxFQUE0QixDQUFDLElBQUssUUFBUyxTQUMzQ0MsRUFBMkIsQ0FBQyxJQUFLLE9BQVEsU0FDekNDLEVBQXVCRixFQUEwQkcsT0FBT0YsR0FROUMsU0FBQUcsRUFBcUJDLEVBQWlCQyxHQUNwRCxNQUFNQyxPQW5CUVIsS0FEUVMsRUFvQmNDLFFBQVFDLElBQUlMLElBbkJyQixHQUFLRyxFQURsQyxJQUF3QkEsRUFzQnRCLE1BQU1HLEdBRE5MLEVBQVVBLEdBQVcsS0FDTUssWUFBYSxFQU94QyxHQU5JQSxJQUNGTCxFQUFVLElBQ0xBLEVBQ0hNLGNBQWVWLElBR0wsS0FBVkssRUFBYyxDQUNoQixRQUE2QlIsSUFBekJPLEVBQVFPLGFBS1YsT0FBT1AsRUFBUU8sYUFKZixRQUE4QmQsSUFBMUJPLEVBQVFNLGdCQUFnQ04sRUFBUU0sY0FBY0UsU0FBUyxJQUN6RSxNQUFNLElBQUlDLFdBQVdwQixFQUFXVSxFQUFTQyxFQUFRTSxjQUFjSSxLQUFLLE9BS3pFLENBQ0QsR0FBSUwsR0FBYVYsRUFBeUJhLFNBQVNQLEdBQVEsT0FBTyxFQUNsRSxHQUFJSSxHQUFhWCxFQUEwQmMsU0FBU1AsR0FBUSxPQUFPLEVBQ25FLFFBQThCUixJQUExQk8sRUFBUU0sZ0JBQWdDTixFQUFRTSxjQUFjRSxTQUFTUCxHQUN6RSxNQUFNLElBQUlRLFdBQVdwQixFQUFXVSxFQUFTQyxFQUFRTSxjQUFjSSxLQUFLLFFBRXRF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
