import t from"axios";import e from"eventsource";import{randomBytes as i}from"node:crypto";import{EventEmitter as o}from"node:events";import{config as s}from"dotenv";s();const r=(t,e)=>{let i=`Invalid value for ${t}. `;return void 0!==e&&(i+=`Allowed values are ${e} `),i},a=["0","false","FALSE"],n=["1","true","FALSE"],l=a.concat(n);function u(t,e){const i=void 0===(o=process.env[t])?"":o;var o;const s=(e=e??{})?.isBoolean??!1;if(s&&(e={...e,allowedValues:l}),""===i){if(void 0!==e.defaultValue)return e.defaultValue;if(void 0!==e.allowedValues&&!e.allowedValues.includes(""))throw new RangeError(r(t,e.allowedValues.join(", ")))}if(s&&n.includes(i))return!0;if(s&&a.includes(i))return!1;if(void 0!==e.allowedValues&&!e.allowedValues.includes(i))throw new RangeError(r(t,e.allowedValues.join(", ")));return i}u("NODE_ENV",{defaultValue:"production",allowedValues:["production","development"]});const h="v"+u("npm_package_version",{defaultValue:"0.0.1"})[0];class d extends o{constructor(t,e){super(),this.name=e??i(16).toString("hex"),this.serverUrl=t,this.vaultPath=`/api/v${h}/vault`}async initEventSourceClient(){if(void 0===this.token)throw new Error("Cannot subscribe to events without login first");const t=this.serverUrl+this.vaultPath+"/events";this.es=new e(t,{headers:{Authorization:"Bearer "+this.token}}),this.es.onmessage=t=>{const e=JSON.parse(t.data);void 0!==e.timestamp&&(this.timestamp=e.timestamp,this.emit("storageUpdated",this.timestamp))},this.es.onerror=t=>(this.emit("error",t),t)}close(){this.logout(),this.emit("close")}async login(e,i){const o={username:e,authkey:i};try{const e=await t.post(this.serverUrl+this.vaultPath+"/auth",o);if(200!==e.status)return!1;const i=e.data;return this.token=i.token,await this.initEventSourceClient(),this.emit("loggedIn"),!0}catch(t){return this.emit("error",t),!1}}logout(){this.token=void 0,this.es.close()}async updateStorage(e,i=!1){if(void 0===this.token)return this.emit("loginRequired"),!1;const o=await t.post(this.serverUrl+this.vaultPath,e,{headers:{Authorization:"Bearer "+this.token,"Content-Type":"application/json"}});if(201!==o.status){return"Unauthorized"===o.data.name?(this.logout(),this.emit("loginRequired")):this.emit("error",o.data),!1}return this.timestamp=o.data.timestamp,!0}async deleteStorage(){if(void 0===this.token)return this.logout(),this.emit("loginRequired"),!1;const e=await t.get(this.serverUrl+this.vaultPath,{headers:{Authorization:"Bearer "+this.token}});if(204!==e.status){return"Unauthorized"===e.data.name?(this.logout(),this.emit("loginRequired")):this.emit("error",e.data),!1}return this.emit("storageDeleted"),!0}}export{d as VaultClient};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXgubm9kZS5qcyIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3RzL2NvbmZpZy9wYXJzZVByb2Nlc3NFbnZWYXIudHMiLCIuLi8uLi9zcmMvdHMvY29uZmlnL2luZGV4LnRzIiwiLi4vLi4vc3JjL3RzL3ZhdWx0LWNsaWVudC50cyJdLCJzb3VyY2VzQ29udGVudCI6bnVsbCwibmFtZXMiOlsibG9hZEVudkZpbGUiLCJpbnZhbGlkTXNnIiwidmFybmFtZSIsInZhbHVlcyIsInJldCIsInVuZGVmaW5lZCIsImJvb2xlYW5GYWxzZUFsbG93ZWRWYWx1ZXMiLCJib29sZWFuVHJ1ZUFsbG93ZWRWYWx1ZXMiLCJib29sZWFuQWxsb3dlZFZhbHVlcyIsImNvbmNhdCIsInBhcnNlUHJvY2Nlc3NFbnZWYXIiLCJ2YXJOYW1lIiwib3B0aW9ucyIsInZhbHVlIiwiYSIsInByb2Nlc3MiLCJlbnYiLCJpc0Jvb2xlYW4iLCJhbGxvd2VkVmFsdWVzIiwiZGVmYXVsdFZhbHVlIiwiaW5jbHVkZXMiLCJSYW5nZUVycm9yIiwiam9pbiIsImFwaVZlcnNpb24iLCJWYXVsdENsaWVudCIsIkV2ZW50RW1pdHRlciIsImNvbnN0cnVjdG9yIiwic2VydmVyVXJsIiwibmFtZSIsInN1cGVyIiwidGhpcyIsInJhbmRvbUJ5dGVzIiwidG9TdHJpbmciLCJ2YXVsdFBhdGgiLCJhc3luYyIsInRva2VuIiwiRXJyb3IiLCJzc2VFbmRwb2ludCIsImVzIiwiRXZlbnRTb3VyY2UiLCJoZWFkZXJzIiwiQXV0aG9yaXphdGlvbiIsIm9ubWVzc2FnZSIsImUiLCJtc2ciLCJKU09OIiwicGFyc2UiLCJkYXRhIiwidGltZXN0YW1wIiwiZW1pdCIsIm9uZXJyb3IiLCJjbG9zZSIsImxvZ291dCIsInVzZXJuYW1lIiwiYXV0aGtleSIsInJlcUJvZHkiLCJyZXMiLCJheGlvcyIsInBvc3QiLCJzdGF0dXMiLCJib2R5IiwiaW5pdEV2ZW50U291cmNlQ2xpZW50IiwiZXJyb3IiLCJzdG9yYWdlIiwiZm9yY2UiLCJn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
