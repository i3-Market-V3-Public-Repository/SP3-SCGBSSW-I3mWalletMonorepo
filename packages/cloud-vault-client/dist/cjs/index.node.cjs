"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t=require("axios"),e=require("eventsource"),i=require("node:crypto"),r=require("node:events"),s=require("dotenv");function o(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var a=o(t),n=o(e);s.config();const u=(t,e)=>{let i=`Invalid value for ${t}. `;return void 0!==e&&(i+=`Allowed values are ${e} `),i},l=["0","false","FALSE"],d=["1","true","FALSE"],h=l.concat(d);function c(t,e){const i=void 0===(r=process.env[t])?"":r;var r;const s=(e=e??{})?.isBoolean??!1;if(s&&(e={...e,allowedValues:h}),""===i){if(void 0!==e.defaultValue)return e.defaultValue;if(void 0!==e.allowedValues&&!e.allowedValues.includes(""))throw new RangeError(u(t,e.allowedValues.join(", ")))}if(s&&d.includes(i))return!0;if(s&&l.includes(i))return!1;if(void 0!==e.allowedValues&&!e.allowedValues.includes(i))throw new RangeError(u(t,e.allowedValues.join(", ")));return i}c("NODE_ENV",{defaultValue:"production",allowedValues:["production","development"]});const v="v"+c("npm_package_version",{defaultValue:"0.0.1"})[0];class m extends r.EventEmitter{constructor(t,e){super(),this.name=e??i.randomBytes(16).toString("hex"),this.serverUrl=t,this.vaultPath=`/api/v${v}/vault`}async initEventSourceClient(){if(void 0===this.token)throw new Error("Cannot subscribe to events without login first");const t=this.serverUrl+this.vaultPath+"/events";this.es=new n.default(t,{headers:{Authorization:"Bearer "+this.token}}),this.es.onmessage=t=>{const e=JSON.parse(t.data);void 0!==e.timestamp&&(this.timestamp=e.timestamp,this.emit("storageUpdated",this.timestamp))},this.es.onerror=t=>(this.emit("error",t),t)}close(){this.logout(),this.emit("close")}async login(t,e){const i={username:t,authkey:e};try{const t=await a.default.post(this.serverUrl+this.vaultPath+"/auth",i);if(200!==t.status)return!1;const e=t.data;return this.token=e.token,await this.initEventSourceClient(),this.emit("loggedIn"),!0}catch(t){return this.emit("error",t),!1}}logout(){this.token=void 0,this.es.close()}async updateStorage(t,e=!1){if(void 0===this.token)return this.emit("loginRequired"),!1;const i=await a.default.post(this.serverUrl+this.vaultPath,t,{headers:{Authorization:"Bearer "+this.token,"Content-Type":"application/json"}});if(201!==i.status){return"Unauthorized"===i.data.name?(this.logout(),this.emit("loginRequired")):this.emit("error",i.data),!1}return this.timestamp=i.data.timestamp,!0}async deleteStorage(){if(void 0===this.token)return this.logout(),this.emit("loginRequired"),!1;const t=await a.default.get(this.serverUrl+this.vaultPath,{headers:{Authorization:"Bearer "+this.token}});if(204!==t.status){return"Unauthorized"===t.data.name?(this.logout(),this.emit("loginRequired")):this.emit("error",t.data),!1}return this.emit("storageDeleted"),!0}}exports.VaultClient=m;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXgubm9kZS5janMiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy90cy9jb25maWcvcGFyc2VQcm9jZXNzRW52VmFyLnRzIiwiLi4vLi4vc3JjL3RzL2NvbmZpZy9pbmRleC50cyIsIi4uLy4uL3NyYy90cy92YXVsdC1jbGllbnQudHMiXSwic291cmNlc0NvbnRlbnQiOm51bGwsIm5hbWVzIjpbImxvYWRFbnZGaWxlIiwiaW52YWxpZE1zZyIsInZhcm5hbWUiLCJ2YWx1ZXMiLCJyZXQiLCJ1bmRlZmluZWQiLCJib29sZWFuRmFsc2VBbGxvd2VkVmFsdWVzIiwiYm9vbGVhblRydWVBbGxvd2VkVmFsdWVzIiwiYm9vbGVhbkFsbG93ZWRWYWx1ZXMiLCJjb25jYXQiLCJwYXJzZVByb2NjZXNzRW52VmFyIiwidmFyTmFtZSIsIm9wdGlvbnMiLCJ2YWx1ZSIsImEiLCJwcm9jZXNzIiwiZW52IiwiaXNCb29sZWFuIiwiYWxsb3dlZFZhbHVlcyIsImRlZmF1bHRWYWx1ZSIsImluY2x1ZGVzIiwiUmFuZ2VFcnJvciIsImpvaW4iLCJhcGlWZXJzaW9uIiwiVmF1bHRDbGllbnQiLCJFdmVudEVtaXR0ZXIiLCJjb25zdHJ1Y3RvciIsInNlcnZlclVybCIsIm5hbWUiLCJzdXBlciIsInRoaXMiLCJyYW5kb21CeXRlcyIsInRvU3RyaW5nIiwidmF1bHRQYXRoIiwiYXN5bmMiLCJ0b2tlbiIsIkVycm9yIiwic3NlRW5kcG9pbnQiLCJlcyIsIkV2ZW50U291cmNlIiwiaGVhZGVycyIsIkF1dGhvcml6YXRpb24iLCJvbm1lc3NhZ2UiLCJlIiwibXNnIiwiSlNPTiIsInBhcnNlIiwiZGF0YSIsInRpbWVzdGFtcCIsImVtaXQiLCJvbmVycm9yIiwiY2xvc2UiLCJsb2dvdXQiLCJ1c2VybmFtZSIsImF1dGhrZXkiLCJyZXFCb2R5IiwicmVzIiwiYXhpb3MiLCJwb3N0Iiwic3RhdHVzIiwiYm9keSIsImluaXRFdmVudFNvdXJjZUNsaWVudCIsImVycm9yIiwic3RvcmFnZSIsImZvcmNlIiwi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
