"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t=require("axios"),e=require("eventsource"),r=require("node:crypto"),i=require("node:events"),s=require("dotenv");function a(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var o=a(t),n=a(e);s.config();const u=(t,e)=>{let r=`Invalid value for ${t}. `;return void 0!==e&&(r+=`Allowed values are ${e} `),r},l=["0","false","FALSE"],h=["1","true","FALSE"],d=l.concat(h);function c(t,e){const r=void 0===(i=process.env[t])?"":i;var i;const s=(e=e??{})?.isBoolean??!1;if(s&&(e={...e,allowedValues:d}),""===r){if(void 0!==e.defaultValue)return e.defaultValue;if(void 0!==e.allowedValues&&!e.allowedValues.includes(""))throw new RangeError(u(t,e.allowedValues.join(", ")))}if(s&&h.includes(r))return!0;if(s&&l.includes(r))return!1;if(void 0!==e.allowedValues&&!e.allowedValues.includes(r))throw new RangeError(u(t,e.allowedValues.join(", ")));return r}c("NODE_ENV",{defaultValue:"production",allowedValues:["production","development"]});const m="v"+c("npm_package_version",{defaultValue:"0.0.1"})[0];class p extends i.EventEmitter{timestamp;token;name;serverUrl;vaultPath;publicKeyPath;es;constructor(t,e){super(),this.name=e??r.randomBytes(16).toString("hex"),this.serverUrl=t,this.vaultPath=`/api/${m}/vault`,this.publicKeyPath=`/api/${m}/registration/public-jwk`}async initEventSourceClient(){if(void 0===this.token)throw new Error("Cannot subscribe to events without login first");const t=this.serverUrl+this.vaultPath+"/events";this.es=new n.default(t,{headers:{Authorization:"Bearer "+this.token}}),this.es.onmessage=t=>{console.log(t)},this.es.addEventListener("connected",(t=>{const e=JSON.parse(t.data);this.emit("connected",e.timestamp)})),this.es.addEventListener("storage-updated",(t=>{const e=JSON.parse(t.data);e.timestamp!==this.timestamp&&(this.timestamp=e.timestamp,this.emit("storage-updated",this.timestamp))})),this.es.addEventListener("storage-deleted",(t=>{this.emit("storage-updated")})),this.es.onerror=t=>{this.emit("error",t)}}close(){this.logout(),this.emit("close")}async login(e,r){const i={username:e,authkey:r};try{const t=await o.default.post(this.serverUrl+this.vaultPath+"/auth",i);if(200!==t.status)return!1;const e=t.data;return this.token=e.token,await this.initEventSourceClient(),this.emit("logged-in"),!0}catch(e){return e instanceof t.AxiosError?this.emit("error",e.response?.data):this.emit("error",e),!1}}logout(){this.token=void 0,this.es?.close()}async getRemoteStorageTimestamp(){try{if(void 0===this.token)return this.emit("login-required"),null;const t=await o.default.get(this.serverUrl+this.vaultPath+"/timestamp",{headers:{Authorization:"Bearer "+this.token,"Content-Type":"application/json"}});if(200!==t.status){const e=t.data;return"Unauthorized"===e.name?(this.logout(),this.emit("login-required")):this.emit("error",new Error(e.name,{cause:e.description})),null}return t.data.timestamp}catch(e){return e instanceof t.AxiosError?this.emit("error",e.response?.data):this.emit("error",e),null}}async updateStorage(e,r=!1){try{if(void 0===this.token)return this.emit("login-required"),!1;if(r){const t=await this.getRemoteStorageTimestamp();e.timestamp=null!==t?t:void 0}const t=await o.default.post(this.serverUrl+this.vaultPath,e,{headers:{Authorization:"Bearer "+this.token,"Content-Type":"application/json"}});if(201!==t.status){return"Unauthorized"===t.data.name?(this.logout(),this.emit("login-required")):this.emit("error",t.data),!1}return this.timestamp=t.data.timestamp,!0}catch(e){e instanceof t.AxiosError?this.emit("error",e.response?.data):this.emit("error",e)}return!1}async deleteStorage(){try{if(void 0===this.token)return this.logout(),this.emit("login-required"),!1;const t=await o.default.delete(this.serverUrl+this.vaultPath,{headers:{Authorization:"Bearer "+this.token}});if(204!==t.status){return"Unauthorized"===t.data.name?(this.logout(),this.emit("login-required")):this.emit("error",t.data),!1}return this.emit("storage-deleted"),!0}catch(e){e instanceof t.AxiosError?this.emit("error",e.response?.data):this.emit("error",e)}return!1}async getServerPublicKey(){try{const t=await o.default.get(this.serverUrl+this.publicKeyPath);return 200!==t.status?(this.emit("error",t.statusText),null):t.data.jwk}catch(e){return e instanceof t.AxiosError?this.emit("error",e.response?.data):this.emit("error",e),null}}}exports.VaultClient=p;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXgubm9kZS5janMiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy90cy9jb25maWcvcGFyc2VQcm9jZXNzRW52VmFyLnRzIiwiLi4vLi4vc3JjL3RzL2NvbmZpZy9pbmRleC50cyIsIi4uLy4uL3NyYy90cy92YXVsdC1jbGllbnQudHMiXSwic291cmNlc0NvbnRlbnQiOm51bGwsIm5hbWVzIjpbImxvYWRFbnZGaWxlIiwiaW52YWxpZE1zZyIsInZhcm5hbWUiLCJ2YWx1ZXMiLCJyZXQiLCJ1bmRlZmluZWQiLCJib29sZWFuRmFsc2VBbGxvd2VkVmFsdWVzIiwiYm9vbGVhblRydWVBbGxvd2VkVmFsdWVzIiwiYm9vbGVhbkFsbG93ZWRWYWx1ZXMiLCJjb25jYXQiLCJwYXJzZVByb2NjZXNzRW52VmFyIiwidmFyTmFtZSIsIm9wdGlvbnMiLCJ2YWx1ZSIsImEiLCJwcm9jZXNzIiwiZW52IiwiaXNCb29sZWFuIiwiYWxsb3dlZFZhbHVlcyIsImRlZmF1bHRWYWx1ZSIsImluY2x1ZGVzIiwiUmFuZ2VFcnJvciIsImpvaW4iLCJhcGlWZXJzaW9uIiwiVmF1bHRDbGllbnQiLCJFdmVudEVtaXR0ZXIiLCJ0aW1lc3RhbXAiLCJ0b2tlbiIsIm5hbWUiLCJzZXJ2ZXJVcmwiLCJ2YXVsdFBhdGgiLCJwdWJsaWNLZXlQYXRoIiwiZXMiLCJjb25zdHJ1Y3RvciIsInN1cGVyIiwidGhpcyIsInJhbmRvbUJ5dGVzIiwidG9TdHJpbmciLCJhc3luYyIsIkVycm9yIiwic3NlRW5kcG9pbnQiLCJFdmVudFNvdXJjZSIsImhlYWRlcnMiLCJBdXRob3JpemF0aW9uIiwib25tZXNzYWdlIiwibXNnIiwiY29uc29sZSIsImxvZyIsImFkZEV2ZW50TGlzdGVuZXIiLCJlIiwiSlNPTiIsInBhcnNlIiwiZGF0YSIsImVtaXQiLCJvbmVycm9yIiwiY2xvc2UiLCJsb2dvdXQiLCJ1c2VybmFtZSIsImF1dGhrZXkiLCJyZXFCb2R5IiwicmVzIiwiYXhpb3MiLCJwb3N0Iiwic3RhdHVzIiwiYm9keSIsImluaXRFdmVudFNvdXJjZUNsaWVudCIsImVycm9yIiwiQXhpb3NFcnJvciIsInJlc3BvbnNlIiwiZ2V0IiwiY2F1c2UiLCJkZXNjcmlwdGlvbiIsInN0b3JhZ2UiLCJmb3JjZSIsImdldFJlbW90ZVN0b3JhZ2VUaW1lc3RhbXAiLCJkZWxldGUiLCJzdGF0dXNUZXh0IiwiandrIl0sIm1hcHBpbmdzIjoib1JBRUFBLEVBQUFBLFNBTUEsTUFBTUMsRUFBYSxDQUFDQyxFQUFpQkMsS0FDbkMsSUFBSUMsRUFBTSxxQkFBcUJGLE1BRS9CLFlBRGVHLElBQVhGLElBQXNCQyxHQUFPLHNCQUFzQkQsTUFDaERDLENBQUcsRUFFTkUsRUFBNEIsQ0FBQyxJQUFLLFFBQVMsU0FDM0NDLEVBQTJCLENBQUMsSUFBSyxPQUFRLFNBQ3pDQyxFQUF1QkYsRUFBMEJHLE9BQU9GLEdBUTlDLFNBQUFHLEVBQXFCQyxFQUFpQkMsR0FDcEQsTUFBTUMsT0FuQlFSLEtBRFFTLEVBb0JjQyxRQUFRQyxJQUFJTCxJQW5CckIsR0FBS0csRUFEbEMsSUFBd0JBLEVBc0J0QixNQUFNRyxHQUROTCxFQUFVQSxHQUFXLEtBQ01LLFlBQWEsRUFPeEMsR0FOSUEsSUFDRkwsRUFBVSxJQUNMQSxFQUNITSxjQUFlVixJQUdMLEtBQVZLLEVBQWMsQ0FDaEIsUUFBNkJSLElBQXpCTyxFQUFRTyxhQUtWLE9BQU9QLEVBQVFPLGFBSmYsUUFBOEJkLElBQTFCTyxFQUFRTSxnQkFBZ0NOLEVBQVFNLGNBQWNFLFNBQVMsSUFDekUsTUFBTSxJQUFJQyxXQUFXcEIsRUFBV1UsRUFBU0MsRUFBUU0sY0FBY0ksS0FBSyxPQUt6RSxDQUNELEdBQUlMLEdBQWFWLEVBQXlCYSxTQUFTUCxHQUFRLE9BQU8sRUFDbEUsR0FBSUksR0FBYVgsRUFBMEJjLFNBQVNQLEdBQVEsT0FBTyxFQUNuRSxRQUE4QlIsSUFBMUJPLEVBQVFNLGdCQUFnQ04sRUFBUU0sY0FBY0UsU0FBU1AsR0FDekUsTUFBTSxJQUFJUSxXQUFXcEIsRUFBV1UsRUFBU0MsRUFBUU0sY0FBY0ksS0FB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
