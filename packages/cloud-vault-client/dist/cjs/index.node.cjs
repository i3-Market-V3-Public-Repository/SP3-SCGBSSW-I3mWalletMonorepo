"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t=require("axios"),e=require("eventsource"),i=require("node:crypto"),r=require("node:events"),s=require("dotenv");function a(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var n=a(t),o=a(e);s.config();const l=(t,e)=>{let i=`Invalid value for ${t}. `;return void 0!==e&&(i+=`Allowed values are ${e} `),i},u=["0","false","FALSE"],h=["1","true","FALSE"],d=u.concat(h);function c(t,e){const i=void 0===(r=process.env[t])?"":r;var r;const s=(e=e??{})?.isBoolean??!1;if(s&&(e={...e,allowedValues:d}),""===i){if(void 0!==e.defaultValue)return e.defaultValue;if(void 0!==e.allowedValues&&!e.allowedValues.includes(""))throw new RangeError(l(t,e.allowedValues.join(", ")))}if(s&&h.includes(i))return!0;if(s&&u.includes(i))return!1;if(void 0!==e.allowedValues&&!e.allowedValues.includes(i))throw new RangeError(l(t,e.allowedValues.join(", ")));return i}c("NODE_ENV",{defaultValue:"production",allowedValues:["production","development"]});const m="v"+c("npm_package_version",{defaultValue:"0.0.1"})[0];class p extends r.EventEmitter{timestamp;token;name;serverUrl;vaultPath;publicKeyPath;es;constructor(t,e){super(),this.name=e??i.randomBytes(16).toString("hex"),this.serverUrl=t,this.vaultPath=`/api/${m}/vault`,this.publicKeyPath=`/api/${m}/registration/public-jwk`}emitError(e){e instanceof t.AxiosError&&void 0!==e.response?"Unauthorized"===e.response.data.name?(this.logout(),this.emit("login-required")):this.emit("error",e.response):this.emit("error",e)}async initEventSourceClient(){if(void 0===this.token)throw new Error("Cannot subscribe to events without login first");const t=this.serverUrl+this.vaultPath+"/events";this.es=new o.default(t,{headers:{Authorization:"Bearer "+this.token}}),this.es.onmessage=t=>{console.log(t)},this.es.addEventListener("connected",(t=>{const e=JSON.parse(t.data);this.emit("connected",e.timestamp)})),this.es.addEventListener("storage-updated",(t=>{const e=JSON.parse(t.data);e.timestamp!==this.timestamp&&(this.timestamp=e.timestamp,this.emit("storage-updated",this.timestamp))})),this.es.addEventListener("storage-deleted",(t=>{this.emit("storage-updated")})),this.es.onerror=t=>{this.emit("error",t)}}close(){this.logout(),this.emit("close")}async login(t,e){const i={username:t,authkey:e};try{const t=await n.default.post(this.serverUrl+this.vaultPath+"/auth",i);if(200!==t.status)return this.emitError(t),!1;const e=t.data;return this.token=e.token,await this.initEventSourceClient(),this.emit("logged-in"),!0}catch(t){return this.emitError(t),!1}}logout(){this.token=void 0,this.es?.close()}async getRemoteStorageTimestamp(){try{if(void 0===this.token)return this.emit("login-required"),null;const t=await n.default.get(this.serverUrl+this.vaultPath+"/timestamp",{headers:{Authorization:"Bearer "+this.token,"Content-Type":"application/json"}});return 200!==t.status?(this.emitError(t),null):t.data.timestamp}catch(t){return this.emitError(t),null}}async updateStorage(t,e=!1){try{if(void 0===this.token)return this.emit("login-required"),!1;if(e){const e=await this.getRemoteStorageTimestamp();t.timestamp=null!==e?e:void 0}const i=await n.default.post(this.serverUrl+this.vaultPath,t,{headers:{Authorization:"Bearer "+this.token,"Content-Type":"application/json"}});return 201!==i.status?(this.emitError(i),!1):(this.timestamp=i.data.timestamp,!0)}catch(t){this.emitError(t)}return!1}async deleteStorage(){try{if(void 0===this.token)return this.logout(),this.emit("login-required"),!1;const t=await n.default.delete(this.serverUrl+this.vaultPath,{headers:{Authorization:"Bearer "+this.token}});return 204!==t.status?(this.emitError(t),!1):(this.emit("storage-deleted"),!0)}catch(t){this.emitError(t)}return!1}async getServerPublicKey(){try{const t=await n.default.get(this.serverUrl+this.publicKeyPath);return 200!==t.status?(this.emitError(t),null):t.data.jwk}catch(t){return this.emitError(t),null}}}async function v(t,e,r=!1){let s={};void 0!==e.algOptions&&(s={N:16384,r:8,p:1,...e.algOptions},s.maxmem=256*s.N*s.r);const a=new Promise(((a,n)=>{i.scrypt(t,e.salt,e.derivedKeyLength,s,((t,e)=>{null!==t&&n(t),a(r?e:i.createSecretKey(e))}))}));return await a}exports.KeyManager=class{_encKey;_authKey;derivationOptions;initialized;constructor(t,e){this.derivationOptions=e,this.initialized=this.init(t)}async init(t){const e=await v(t,this.derivationOptions.master,!0),[i,r]=await Promise.all([v(e,this.derivationOptions.auth),v(e,this.derivationOptions.enc)]);this._authKey=i,this._encKey=r}async getAuthKey(){return await this.initialized,this._authKey.export().toString("base64url")}async getEncKey(){return await this.initialized,this._encKey}},exports.VaultClient=p,exports.deriveKey=v;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXgubm9kZS5janMiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy90cy9jb25maWcvcGFyc2VQcm9jZXNzRW52VmFyLnRzIiwiLi4vLi4vc3JjL3RzL2NvbmZpZy9pbmRleC50cyIsIi4uLy4uL3NyYy90cy92YXVsdC1jbGllbnQudHMiLCIuLi8uLi9zcmMvdHMva2V5LW1hbmFnZXIudHMiXSwic291cmNlc0NvbnRlbnQiOm51bGwsIm5hbWVzIjpbImxvYWRFbnZGaWxlIiwiaW52YWxpZE1zZyIsInZhcm5hbWUiLCJ2YWx1ZXMiLCJyZXQiLCJ1bmRlZmluZWQiLCJib29sZWFuRmFsc2VBbGxvd2VkVmFsdWVzIiwiYm9vbGVhblRydWVBbGxvd2VkVmFsdWVzIiwiYm9vbGVhbkFsbG93ZWRWYWx1ZXMiLCJjb25jYXQiLCJwYXJzZVByb2NjZXNzRW52VmFyIiwidmFyTmFtZSIsIm9wdGlvbnMiLCJ2YWx1ZSIsImEiLCJwcm9jZXNzIiwiZW52IiwiaXNCb29sZWFuIiwiYWxsb3dlZFZhbHVlcyIsImRlZmF1bHRWYWx1ZSIsImluY2x1ZGVzIiwiUmFuZ2VFcnJvciIsImpvaW4iLCJhcGlWZXJzaW9uIiwiVmF1bHRDbGllbnQiLCJFdmVudEVtaXR0ZXIiLCJ0aW1lc3RhbXAiLCJ0b2tlbiIsIm5hbWUiLCJzZXJ2ZXJVcmwiLCJ2YXVsdFBhdGgiLCJwdWJsaWNLZXlQYXRoIiwiZXMiLCJjb25zdHJ1Y3RvciIsInN1cGVyIiwidGhpcyIsInJhbmRvbUJ5dGVzIiwidG9TdHJpbmciLCJlbWl0RXJyb3IiLCJlcnJvciIsIkF4aW9zRXJyb3IiLCJyZXNwb25zZSIsImRhdGEiLCJsb2dvdXQiLCJlbWl0IiwiYXN5bmMiLCJFcnJvciIsInNzZUVuZHBvaW50IiwiRXZlbnRTb3VyY2UiLCJoZWFkZXJzIiwiQXV0aG9yaXphdGlvbiIsIm9ubWVzc2FnZSIsIm1zZyIsImNvbnNvbGUiLCJsb2ciLCJhZGRFdmVudExpc3RlbmVyIiwiZSIsIkpTT04iLCJwYXJzZSIsIm9uZXJyb3IiLCJjbG9zZSIsInVzZXJuYW1lIiwiYXV0aGtleSIsInJlcUJvZHkiLCJyZXMiLCJheGlvcyIsInBvc3QiLCJzdGF0dXMiLCJib2R5IiwiaW5pdEV2ZW50U291cmNlQ2xpZW50IiwiZ2V0Iiwic3RvcmFnZSIsImZvcmNlIiwiZ2V0UmVtb3RlU3RvcmFnZVRpbWVzdGFtcCIsImRlbGV0ZSIsImp3ayIsImRlcml2ZUtleSIsInBhc3N3b3JkIiwib3B0cyIsInJldHVybkJ1ZmZlciIsInNjcnlwdE9wdGlvbnMiLCJhbGdPcHRpb25zIiwiTiIsInIiLCJwIiwibWF4bWVtIiwia2V5UHJvbWlzZSIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0Iiwic2NyeXB0Iiwic2FsdCIsImRlcml2ZWRLZXlMZW5ndGgiLCJlcnIiLCJrZXkiLCJjcmVhdGVTZWNyZXRLZXkiLCJfZW5jS2V5IiwiX2F1dGhLZXkiLCJkZXJpdmF0aW9uT3B0aW9ucyIsImluaXRpYWxpemVkIiwiaW5pdCIsIm1hc3RlcktleSIsIm1hc3RlciIsImF1dGhLZXkiLCJlbmNLZXkiLCJhbGwiLCJhdXRoIiwiZW5jIiwiZXhwb3J0Il0sIm1hcHBpbmdzIjoib1JBRUFBLEVBQUFBLFNBTUEsTUFBTUMsRUFBYSxDQUFDQyxFQUFpQkMsS0FDbkMsSUFBSUMsRUFBTSxxQkFBcUJGLE1BRS9CLFlBRGVHLElBQVhGLElBQXNCQyxHQUFPLHNCQUFzQkQsTUFDaERDLENBQUcsRUFFTkUsRUFBNEIsQ0FBQyxJQUFLLFFBQVMsU0FDM0NDLEVBQTJCLENBQUMsSUFBSyxPQUFRLFNBQ3pDQyxFQUF1QkYsRUFBMEJHLE9BQU9GLEdBUTlDLFNBQUFHLEVBQXFCQyxFQUFpQkMsR0FDcEQsTUFBTUMsT0FuQlFSLEtBRFFTLEVBb0JjQyxRQUFRQyxJQUFJTCxJQW5CckIsR0FBS0csRUFEbEMsSUFBd0JBLEVBc0J0QixNQUFNRyxHQUROTCxFQUFVQSxHQUFXLEtBQ01LLFlBQWEsRUFPeEMsR0FOSUEsSUFDRkwsRUFBVSxJQUNMQSxFQUNITSxjQUFlVixJQUdMLEtBQVZLLEVB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
