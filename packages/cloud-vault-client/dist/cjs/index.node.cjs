"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t=require("axios"),e=require("eventsource"),i=require("node:crypto"),s=require("node:events"),r=require("dotenv");function a(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var o=a(t),n=a(e);r.config();const u=(t,e)=>{let i=`Invalid value for ${t}. `;return void 0!==e&&(i+=`Allowed values are ${e} `),i},l=["0","false","FALSE"],d=["1","true","FALSE"],h=l.concat(d);function c(t,e){const i=void 0===(s=process.env[t])?"":s;var s;const r=(e=e??{})?.isBoolean??!1;if(r&&(e={...e,allowedValues:h}),""===i){if(void 0!==e.defaultValue)return e.defaultValue;if(void 0!==e.allowedValues&&!e.allowedValues.includes(""))throw new RangeError(u(t,e.allowedValues.join(", ")))}if(r&&d.includes(i))return!0;if(r&&l.includes(i))return!1;if(void 0!==e.allowedValues&&!e.allowedValues.includes(i))throw new RangeError(u(t,e.allowedValues.join(", ")));return i}c("NODE_ENV",{defaultValue:"production",allowedValues:["production","development"]});const v="v"+c("npm_package_version",{defaultValue:"0.0.1"})[0];class m extends s.EventEmitter{constructor(t,e){super(),this.name=e??i.randomBytes(16).toString("hex"),this.serverUrl=t,this.vaultPath=`/api/v${v}/vault`}async initEventSourceClient(){if(void 0===this.token)throw new Error("Cannot subscribe to events without login first");const t=this.serverUrl+this.vaultPath+"/events";this.es=new n.default(t,{headers:{Authorization:"Bearer "+this.token}}),this.es.addEventListener("connected",(t=>{const e=JSON.parse(t.data);this.emit("connected",e.timestamp)})),this.es.addEventListener("storage-updated",(t=>{const e=JSON.parse(t.data);e.timestamp!==this.timestamp&&(this.timestamp=e.timestamp,this.emit("storage-updated",this.timestamp))})),this.es.addEventListener("storage-deleted",(t=>{this.emit("storage-updated")})),this.es.onerror=t=>{this.emit("error",t)}}close(){this.logout(),this.emit("close")}async login(t,e){const i={username:t,authkey:e};try{const t=await o.default.post(this.serverUrl+this.vaultPath+"/auth",i);if(200!==t.status)return!1;const e=t.data;return this.token=e.token,await this.initEventSourceClient(),this.emit("logged-in"),!0}catch(t){return this.emit("error",t),!1}}logout(){this.token=void 0,this.es.close()}async updateStorage(t,e=!1){if(void 0===this.token)return this.emit("login-required"),!1;const i=await o.default.post(this.serverUrl+this.vaultPath,t,{headers:{Authorization:"Bearer "+this.token,"Content-Type":"application/json"}});if(201!==i.status){return"Unauthorized"===i.data.name?(this.logout(),this.emit("login-required")):this.emit("error",i.data),!1}return this.timestamp=i.data.timestamp,!0}async deleteStorage(){if(void 0===this.token)return this.logout(),this.emit("login-required"),!1;const t=await o.default.get(this.serverUrl+this.vaultPath,{headers:{Authorization:"Bearer "+this.token}});if(204!==t.status){return"Unauthorized"===t.data.name?(this.logout(),this.emit("login-required")):this.emit("error",t.data),!1}return this.emit("storage-deleted"),!0}}exports.VaultClient=m;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXgubm9kZS5janMiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy90cy9jb25maWcvcGFyc2VQcm9jZXNzRW52VmFyLnRzIiwiLi4vLi4vc3JjL3RzL2NvbmZpZy9pbmRleC50cyIsIi4uLy4uL3NyYy90cy92YXVsdC1jbGllbnQudHMiXSwic291cmNlc0NvbnRlbnQiOm51bGwsIm5hbWVzIjpbImxvYWRFbnZGaWxlIiwiaW52YWxpZE1zZyIsInZhcm5hbWUiLCJ2YWx1ZXMiLCJyZXQiLCJ1bmRlZmluZWQiLCJib29sZWFuRmFsc2VBbGxvd2VkVmFsdWVzIiwiYm9vbGVhblRydWVBbGxvd2VkVmFsdWVzIiwiYm9vbGVhbkFsbG93ZWRWYWx1ZXMiLCJjb25jYXQiLCJwYXJzZVByb2NjZXNzRW52VmFyIiwidmFyTmFtZSIsIm9wdGlvbnMiLCJ2YWx1ZSIsImEiLCJwcm9jZXNzIiwiZW52IiwiaXNCb29sZWFuIiwiYWxsb3dlZFZhbHVlcyIsImRlZmF1bHRWYWx1ZSIsImluY2x1ZGVzIiwiUmFuZ2VFcnJvciIsImpvaW4iLCJhcGlWZXJzaW9uIiwiVmF1bHRDbGllbnQiLCJFdmVudEVtaXR0ZXIiLCJjb25zdHJ1Y3RvciIsInNlcnZlclVybCIsIm5hbWUiLCJzdXBlciIsInRoaXMiLCJyYW5kb21CeXRlcyIsInRvU3RyaW5nIiwidmF1bHRQYXRoIiwiYXN5bmMiLCJ0b2tlbiIsIkVycm9yIiwic3NlRW5kcG9pbnQiLCJlcyIsIkV2ZW50U291cmNlIiwiaGVhZGVycyIsIkF1dGhvcml6YXRpb24iLCJhZGRFdmVudExpc3RlbmVyIiwiZSIsIm1zZyIsIkpTT04iLCJwYXJzZSIsImRhdGEiLCJlbWl0IiwidGltZXN0YW1wIiwib25lcnJvciIsImNsb3NlIiwibG9nb3V0IiwidXNlcm5hbWUiLCJhdXRoa2V5IiwicmVxQm9keSIsInJlcyIsImF4aW9zIiwicG9zdCIsInN0YXR1cyIsImJvZHkiLCJpbml0RXZlbnRTb3VyY2VDbGllbnQiLCJlcnJvciIsInN0b3JhZ2UiLCJm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
